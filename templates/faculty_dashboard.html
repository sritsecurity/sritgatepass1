<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Faculty Portal | SRIT</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
    <header class="main-header">
        <div style="display:flex; align-items:center; gap:10px;">
            <img src="{{ url_for('static', filename='srit_logo.png') }}" height="40"
                style="background:white; border-radius:50%; padding:2px;">
            <div>
                <h1>Faculty Portal</h1>
                <p>Welcome, {{ session['name'] }}</p>
            </div>
        </div>
        <a href="/" class="logout-btn">Logout</a>
    </header>

    <div class="container" style="max-width:800px;">
        <div class="card">
            <h2
                style="margin-top:0; color:var(--primary); border-bottom:1px solid #e2e8f0; padding-bottom:1rem; margin-bottom:1.5rem;">
                üìÖ Schedule Appointment
            </h2>

            <form id="bookingForm">
                <div style="background:#f8fafc; padding:1.5rem; border-radius:12px; margin-bottom:1.5rem;">
                    <h4
                        style="margin:0 0 1rem 0; color:var(--accent); border-bottom: 2px solid #e2e8f0; padding-bottom: 5px;">
                        1. Visitor Information</h4>

                    <div class="row">
                        <div>
                            <label>Mobile Number</label>
                            <input type="number" id="v_mobile" placeholder="Search by mobile..." onblur="checkVisitor()"
                                required>
                        </div>
                        <div>
                            <label>Full Name</label>
                            <input type="text" id="v_name" placeholder="Visitor Name" required>
                        </div>
                    </div>

                    <div id="status-msg"
                        style="margin-top:0.5rem; font-size:0.85rem; font-weight:600; min-height:20px;"></div>

                    <div class="row" style="margin-top:1rem;">
                        <div>
                            <label>Organization</label>
                            <input type="text" id="v_company" placeholder="Company / Institution">
                        </div>
                        <div>
                            <label>Vehicle Number</label>
                            <input type="text" id="v_vehicle" placeholder="TN XX ...">
                        </div>
                        <div>
                            <label>Purpose</label>
                            <select id="v_purpose">
                                <option value="Official Visit">Official Visit</option>
                                <option value="Meeting">Meeting</option>
                                <option value="Inspection">Inspection</option>
                                <option value="Guest Lecture">Guest Lecture</option>
                                <option value="Personal">Personal</option>
                                <option value="Others">Others</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div style="background:#f8fafc; padding:1.5rem; border-radius:12px;">
                    <h4
                        style="margin:0 0 1rem 0; color:var(--accent); border-bottom: 2px solid #e2e8f0; padding-bottom: 5px;">
                        2. Meeting Details</h4>
                    <div class="row">
                        <div>
                            <label>Host Name</label>
                            <input type="text" id="host_name" value="{{ session['name'] }}" style="font-weight:600;">
                        </div>
                        <div>
                            <label>Department</label>
                            <input type="text" id="host_dept" value="{{ session['dept'] }}" style="font-weight:600;">
                        </div>
                    </div>
                </div>

                <button type="button" class="action-btn" onclick="submitBooking()"
                    style="margin-top:1.5rem; width:100%;">‚úÖ Confirm Appointment</button>
                <p id="msg" style="text-align:center; margin-top:1rem; font-weight:600;"></p>
            </form>
        </div>

        <div class="card">
            <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">üìú My Booking History</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Visitor</th>
                            <th>Mobile</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="my-bookings-body">
                        <tr>
                            <td colspan="4" style="text-align:center">Loading history...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // --- AUTO FETCH FUNCTION ---
        async function checkVisitor() {
            const mobile = document.getElementById('v_mobile').value;
            const msg = document.getElementById('status-msg');

            if (mobile.length !== 10) { msg.innerText = ""; return; }

            msg.innerText = "üîç Checking Database...";
            msg.style.color = "var(--text-light)";

            try {
                const res = await fetch(`/api/check_visitor?mobile=${mobile}`);
                const data = await res.json();

                if (data.found) {
                    document.getElementById('v_name').value = data.name || "";
                    document.getElementById('v_company').value = data.company || "";
                    if (data.vehicle) document.getElementById('v_vehicle').value = data.vehicle;

                    // AUTO-FETCH HOST from Last Visit (Optional feature requested)
                    if (data.to_meet && data.department) {
                        // We set it only if user wants it, or we just pre-fill. 
                        // Since you wanted autofill logic, here it is:
                        // Uncomment if you want to overwrite session defaults aggressively
                        // document.getElementById('host_name').value = data.to_meet;
                        // document.getElementById('host_dept').value = data.department;
                    }

                    msg.innerHTML = "‚ú® Visitor Found! Details Auto-filled.";
                    msg.style.color = "var(--success)";
                } else {
                    msg.innerHTML = "üìù New Visitor";
                    msg.style.color = "var(--primary)";
                }
            } catch (e) {
                console.error(e);
                msg.innerText = "‚ö†Ô∏è Network Error checking visitor";
                msg.style.color = "red";
            }
        }

        // --- SUBMIT FUNCTION ---
        async function submitBooking() {
            const btn = document.querySelector('.action-btn');
            const msg = document.getElementById('msg');

            const name = document.getElementById('v_name').value;
            const mobile = document.getElementById('v_mobile').value;

            if (!name || !mobile || mobile.length !== 10) {
                alert("Please provide valid Name and 10-digit Mobile Number");
                return;
            }

            btn.innerText = "Processing...";
            btn.disabled = true;

            const data = {
                name: name,
                mobile: mobile,
                company: document.getElementById('v_company').value,
                vehicle: document.getElementById('v_vehicle').value,
                purpose: document.getElementById('v_purpose').value,
                to_meet: document.getElementById('host_name').value, // Use the Editable Field
                department: document.getElementById('host_dept').value // Use the Editable Field
            };

            try {
                const res = await fetch('/api/book_visitor', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();

                if (result.status === 'success') {
                    msg.innerText = "‚úÖ Appointment Scheduled Successfully!";
                    msg.style.color = "var(--success)";
                    document.getElementById('bookingForm').reset();
                    // Restore defaults from session (hidden way or reload)
                    setTimeout(() => window.location.reload(), 2000);
                } else {
                    msg.innerText = "‚ùå Error: " + result.message;
                    msg.style.color = "var(--danger)";
                    btn.innerText = "‚úÖ Confirm Appointment";
                    btn.disabled = false;
                }
            } catch (e) {
                msg.innerText = "‚ö†Ô∏è Network Error";
                msg.style.color = "red";
                btn.disabled = false;
            }
        }

        // --- LOAD MY BOOKINGS ---
        async function loadMyBookings() {
            try {
                const res = await fetch('/api/get_user_bookings');
                const data = await res.json();
                const tbody = document.getElementById('my-bookings-body');
                tbody.innerHTML = "";

                if (data.length === 0) {
                    tbody.innerHTML = "<tr><td colspan='4' style='text-align:center; padding:15px;'>No previous bookings found.</td></tr>";
                    return;
                }

                data.forEach(row => {
                    let badgeColor = row.status === 'Arrived' ? 'green' : 'yellow';
                    tbody.innerHTML += `
                        <tr>
                            <td>${row.time.split(' ')[0]}</td>
                            <td>${row.visitor}</td>
                            <td>${row.mobile}</td>
                            <td><span class="badge badge-${badgeColor}">${row.status}</span></td>
                        </tr>
                    `;
                });
            } catch (e) { console.error("Error loading history", e); }
        }

        loadMyBookings();
    </script>
    <div
        style="position: fixed; bottom: 10px; right: 15px; color: rgba(0, 0, 0, 0.3); font-size: 12px; font-family: sans-serif; font-weight: 600; pointer-events: none; z-index: 9999;">
        Designed and Developed by Keethapriyan MR and Alan S at HIVE
    </div>
</body>

</html>